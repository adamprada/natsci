\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{natsci}[2020/09/20 Natural Sciences Typesetting]
\RequirePackage{iftex}

%*******************************************************************************
% Fonts
%*******************************************************************************
\ifxetex
    \RequirePackage{fontspec}
    %\defaultfontfeatures{Ligatures=TeX,Numbers=OldStyle,Contextuals=Alternate}
    \defaultfontfeatures{Ligatures=TeX,Numbers=Lining,Contextuals=Alternate}
    \RequirePackage{ucharclasses}
    \RequirePackage[babelshorthands]{polyglossia}
\else

    \RequirePackage[utf8]{inputenc}
    % Using the T1 for font encoding ensures better non-ASCII chracters (as opposed to old OT1)
    \RequirePackage[T1]{fontenc}
\fi
%*******************************************************************************
% Mathematics packages
%*******************************************************************************
\RequirePackage{amsmath}
\RequirePackage{amsthm}
\RequirePackage{mathtools}
\ifxetex
    \RequirePackage[math-style=ISO]{unicode-math}
    % it is better if unicode-math is loaded after amsmath and mathtools
    %************************************
    % Mathematical typesetting macros
    %************************************
    \newcommand{\vc}[1]{\symbf{#1}}
    \newcommand{\mat}[1]{\symbfsfit{#1}}
    \newcommand{\ud}{\ensuremath{\symup{d}}}
    \newcommand{\uDelta}{\ensuremath{\symup{\Delta}}}
    \newcommand{\udelta}{\ensuremath{\symup{\delta}}}
    \newcommand{\ui}{\ensuremath{\symup{i}}}
    \newcommand{\ue}{\ensuremath{\symup{e}}}
    \newcommand{\upi}{\ensuremath{\symup{\pi}}}
    \newcommand{\transp}{\ensuremath{{\symsfup{T}}}}
    \newcommand{\std}{{\ensuremath{\circlehbar}}}
\else
    \RequirePackage{bm}
    \RequirePackage{upgreek}
    % it is better if unicode-math is loaded after amsmath and mathtools
    %************************************
    % Mathematical typesetting macros
    %************************************
    \newcommand{\vc}[1]{\bm{#1}}
    \DeclareMathAlphabet{\mathsfit}{T1}{\sfdefault}{\mddefault}{\sldefault}
    \SetMathAlphabet{\mathsfit}{bold}{T1}{\sfdefault}{\bfdefault}{\sldefault}
    \newcommand{\mat}[1]{\mathsfit{#1}}
    \newcommand{\ud}{\ensuremath{\mathrm{d}}}
    \newcommand{\uDelta}{\ensuremath{\Delta}}
    \newcommand{\udelta}{\ensuremath{\delta}}
    \newcommand{\ui}{\ensuremath{\mathrm{i}}}
    \newcommand{\ue}{\ensuremath{\mathrm{e}}}
    \newcommand{\upi}{\ensuremath{\uppi}}
    \newcommand{\transp}{\ensuremath{{\mathsf{T}}}}
\fi
%*******************************************************************************
% Footnotes (currently unused)
%*******************************************************************************
%\renewcommand{\thefootnote}{\fnsymbol{footnote}}
%\renewcommand{\thefootnote}{(\roman{footnote})}

%\RequirePackage{manyfoot}
% Correction for hyperlinks for manyfoot footnotes
%\RequirePackage{etoolbox}
%\makeatletter
%\newcommand\manyfoottarget{\makebox[0pt][r]{\hypertarget{Hfootnote.\theHfootnote}\quad}}
%\patchcmd\MFL@fnoteplain{\rule}{\manyfoottarget\rule}{}{\fail}
%makeatother
%\DeclareNewFootnote{A}[fnsymbol]

%\RequirePackage{perpage}
%\MakePerPage{footnoteA}
%*******************************************************************************
% General LaTeX packages
%*******************************************************************************
\RequirePackage{geometry} % Page geometry
\RequirePackage{graphicx} % Inserting graphics
\RequirePackage{xcolor} % Using colour
\RequirePackage{microtype} % Correcting minor typesetting errors
\RequirePackage{ragged2e} % Better left and right alignment
\RequirePackage{multicol} % Multi-column documents
\RequirePackage{fancyhdr} % Headers and footers
\RequirePackage{setspace} % Line spacing
\RequirePackage{pdflscape} % Landscape pages are landscape in the PDF
\RequirePackage{caption} % Better float captions
\RequirePackage{subcaption} % Like cpation, but for subfigures
%*******************************************************************************
% Packages for specific elements
%*******************************************************************************
\RequirePackage[hidelinks]{hyperref} % Links in the PDF
%\RequirePackage{footnotebackref}
\RequirePackage{doi} % Automatic DOI typesetting
\RequirePackage{tikz}
\RequirePackage{enumitem} % Better enumerations and itemizations
\RequirePackage{tabularx}
% Aligned flexible width columns
\newcolumntype{L}{>{\raggedright\arraybackslash}X}
\newcolumntype{C}{>{\centering\arraybackslash}X}
\newcolumntype{R}{>{\raggedleft\arraybackslash}X}
\RequirePackage{booktabs} % Nicer tables
\RequirePackage{multirow} % Tables with cells across rows
\RequirePackage{float} % More control over floats
\RequirePackage[shortcuts]{extdash} % Non-breaking hyphens
%\RequirePackage{todonotes}
%*******************************************************************************
% STEM LaTeX packages
%*******************************************************************************
\RequirePackage{siunitx}
\RequirePackage{diffcoeff}[=v4]
\ifxetex
    \diffdef {}{
        op-symbol    = \symup{d},
        op-order-sep = 0 mu
    }
\else
    \diffdef {}{
        op-symbol    = \mathrm{d},
        op-order-sep = 0 mu
    }
\fi
\RequirePackage{chemmacros}
\chemsetup{formula=chemformula}
\chemsetup{modules=all}
\chemsetup[particles]{elpair=dots}
\chemsetup[redox]{pos=top}
\renewcommand{\Ka}[1][]{
    \ensuremath{K_{\mathrm{a}#1}}
}
\renewcommand{\Kb}[1][]{
    \ensuremath{K_{\mathrm{b}#1}}
}